---
import Card from "../Card.astro";
import Button from "../Button.astro";
---

<Card title="Registro de Asesor JLC">
  <form id="registration-form" class="registration-form">
    <!-- SECCI√ìN 1: INFORMACI√ìN PERSONAL -->
    <fieldset>
      <legend>Informaci√≥n Personal</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="nombre" class="form-label">Nombre</label>
          <input
            type="text"
            id="nombre"
            name="nombre"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="apellido" class="form-label">Apellido</label>
          <input
            type="text"
            id="apellido"
            name="apellido"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="tipo_documento" class="form-label"
            >Tipo de Documento</label
          >
          <select
            id="tipo_documento"
            name="tipo_documento"
            class="form-input"
            required
          >
            <option value="CC">C√©dula de Ciudadan√≠a (CC)</option>
            <option value="CE">C√©dula de Extranjer√≠a (CE)</option>
            <option value="NIT">NIT</option>
            <option value="Pasaporte">Pasaporte</option>
          </select>
        </div>
        <div class="form-group">
          <label for="numero_documento" class="form-label"
            >N√∫mero de Documento</label
          >
          <input
            type="text"
            id="numero_documento"
            name="numero_documento"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="fecha_nacimiento" class="form-label"
            >Fecha de Nacimiento</label
          >
          <input
            type="date"
            id="fecha_nacimiento"
            name="fecha_nacimiento"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="correo" class="form-label">Correo Electr√≥nico</label>
          <input
            type="email"
            id="correo"
            name="correo"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="departamento" class="form-label">Departamento</label>
          <input
            type="text"
            id="departamento"
            name="departamento"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="ciudad_residencia" class="form-label"
            >Ciudad de Residencia</label
          >
          <input
            type="text"
            id="ciudad_residencia"
            name="ciudad_residencia"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="whatsapp" class="form-label">WhatsApp</label>
          <input
            type="tel"
            id="whatsapp"
            name="whatsapp"
            class="form-input"
            placeholder="+57 3001234567"
            required
          />
        </div>
        <div class="form-group">
          <label for="telefono" class="form-label">Tel√©fono (Opcional)</label>
          <input type="tel" id="telefono" name="telefono" class="form-input" />
        </div>
      </div>
    </fieldset>

    <!-- SECCI√ìN 2: INFORMACI√ìN DE DISTRIBUIDOR -->
    <fieldset>
      <legend>Informaci√≥n de Distribuidor</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="nombre_distribuidor" class="form-label"
            >Nombre del Distribuidor</label
          >
          <input
            type="text"
            id="nombre_distribuidor"
            name="nombre_distribuidor"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="ciudad_punto_venta" class="form-label"
            >Ciudad del Punto de Venta</label
          >
          <input
            type="text"
            id="ciudad_punto_venta"
            name="ciudad_punto_venta"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="direccion_punto_venta" class="form-label"
            >Direcci√≥n Punto de Venta (Opcional)</label
          >
          <input
            type="text"
            id="direccion_punto_venta"
            name="direccion_punto_venta"
            class="form-input"
          />
        </div>
        <div class="form-group">
          <label for="cargo" class="form-label">Cargo</label>
          <input
            type="text"
            id="cargo"
            name="cargo"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="antiguedad_meses" class="form-label"
            >Antig√ºedad (meses)</label
          >
          <input
            type="number"
            id="antiguedad_meses"
            name="antiguedad_meses"
            class="form-input"
            min="0"
            required
          />
        </div>
      </div>
    </fieldset>

    <!-- SECCI√ìN 3: INFORMACI√ìN FINANCIERA -->
    <fieldset>
      <legend>Informaci√≥n Financiera</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="metodo_pago" class="form-label">M√©todo de Pago</label>
          <select
            id="metodo_pago"
            name="metodo_pago"
            class="form-input"
            required
          >
            <option value="Nequi">Nequi</option>
            <option value="Daviplata">Daviplata</option>
            <option value="Bancolombia">Bancolombia</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="llave_breb" class="form-label">Llave BRE-B</label>
          <input
            type="text"
            id="llave_breb"
            name="llave_breb"
            class="form-input"
            required
          />
          <p class="form-helper-text warning">
            ‚ö†Ô∏è La llave debe coincidir con tu nombre completo o no se realizar√°n
            pagos de bonos.
          </p>
        </div>
      </div>
    </fieldset>

    <!-- SECCI√ìN 4: CONTRASE√ëA Y POL√çTICAS -->
    <fieldset>
      <legend>Seguridad y Pol√≠ticas</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="password" class="form-label">Contrase√±a</label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-input"
            required
          />
          <p class="form-helper-text">
            M√≠nimo 8 caracteres, al menos 1 n√∫mero.
          </p>
        </div>
        <div class="form-group">
          <label for="password_confirm" class="form-label"
            >Confirmar Contrase√±a</label
          >
          <input
            type="password"
            id="password_confirm"
            name="password_confirm"
            class="form-input"
            required
          />
        </div>
      </div>
      <div class="accept-all-container">
        <Button type="button" variant="primary" id="accept-all-terms-btn">
          Aceptar Todos los T√©rminos y Declaraciones
        </Button>
      </div>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input
            type="checkbox"
            id="acepta_tratamiento_datos"
            name="acepta_tratamiento_datos"
            required
          />
          <label for="acepta_tratamiento_datos"
            >Acepto el tratamiento de datos personales.</label
          >
        </div>
        <div class="checkbox-item">
          <input
            type="checkbox"
            id="acepta_contacto_comercial"
            name="acepta_contacto_comercial"
            required
          />
          <label for="acepta_contacto_comercial"
            >Acepto recibir contacto comercial.</label
          >
        </div>
        <div class="checkbox-item">
          <input
            type="checkbox"
            id="declara_info_verdadera"
            name="declara_info_verdadera"
            required
          />
          <label for="declara_info_verdadera"
            >Declaro que toda la informaci√≥n es verdadera.</label
          >
        </div>
      </div>
    </fieldset>

    <!-- SECCI√ìN 5: DECLARACIONES LEGALES DEL PROGRAMA -->
    <fieldset>
      <legend>Declaraciones Legales del Programa de Incentivos JLC</legend>
      <div class="terms-link-box">
        <p>
          üìÑ Puedes consultar los
          <a href="/terminosycondiciones" target="_blank" class="terms-link">
            T√©rminos y Condiciones completos aqu√≠
          </a>
        </p>
      </div>
      <p class="legal-intro">
        Es obligatorio leer y aceptar todas las declaraciones legales para
        participar en el Programa de Incentivos:
      </p>

      <div class="legal-declarations">
        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="declara_naturaleza_comercial"
            name="declara_naturaleza_comercial"
            required
          />
          <label for="declara_naturaleza_comercial"
            >Declaro de manera libre, expresa, voluntaria e informada que mi
            participaci√≥n en el Programa de Incentivos de JL y RB S.A.S. ‚Äì JLC
            tiene naturaleza estrictamente comercial y promocional, y no
            configura relaci√≥n laboral, ni contrato de trabajo, ni contrato
            realidad, ni v√≠nculo civil o comercial alguno con JLC, conforme a
            los art√≠culos 22, 23 y 24 del C√≥digo Sustantivo del Trabajo.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="reconoce_no_salario"
            name="reconoce_no_salario"
            required
          />
          <label for="reconoce_no_salario"
            >Reconozco que los incentivos, bonificaciones o beneficios que
            eventualmente reciba no constituyen salario, no son remuneraci√≥n, no
            son habituales ni peri√≥dicos, y no integran la base salarial, de
            conformidad con el art√≠culo 128 del C√≥digo Sustantivo del Trabajo,
            ni generan prestaciones sociales, aportes a seguridad social o
            parafiscales.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="declara_no_subordinacion"
            name="declara_no_subordinacion"
            required
          />
          <label for="declara_no_subordinacion"
            >Manifiesto que no existe subordinaci√≥n jur√≠dica, t√©cnica ni
            econ√≥mica por parte de JLC, que no estoy sujeto a √≥rdenes, control
            disciplinario, cumplimiento de horarios, metas permanentes,
            exclusividad, ni dependencia alguna frente a JLC.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="declara_relacion_autonoma"
            name="declara_relacion_autonoma"
            required
          />
          <label for="declara_relacion_autonoma"
            >Declaro que mantengo una relaci√≥n laboral, comercial o contractual
            exclusiva y aut√≥noma con un distribuidor, empleador o empresa
            distinta a JLC, siendo dicha relaci√≥n ajena e independiente, sin que
            JLC asuma responsabilidad solidaria, subsidiaria o concurrente.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="acepta_liberalidades"
            name="acepta_liberalidades"
            required
          />
          <label for="acepta_liberalidades"
            >Acepto que los incentivos corresponden a liberalidades
            empresariales ocasionales, otorgadas como reconocimiento comercial
            condicionado, sin generar derechos adquiridos, estabilidad,
            continuidad, expectativa de pago ni ingresos recurrentes.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="asume_obligaciones_tributarias"
            name="asume_obligaciones_tributarias"
            required
          />
          <label for="asume_obligaciones_tributarias"
            >Asumo de manera exclusiva las obligaciones tributarias, fiscales y
            declarativas ante la DIAN, incluyendo impuestos, retenciones o
            costos que se deriven de los incentivos recibidos, exonerando
            expresa e irrevocablemente a JLC de cualquier responsabilidad fiscal
            o laboral.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="declara_no_contrato"
            name="declara_no_contrato"
            required
          />
          <label for="declara_no_contrato"
            >Declaro que esta aceptaci√≥n no constituye contrato verbal ni
            escrito, ni podr√° ser utilizada para alegar v√≠nculo laboral o
            contrato realidad en el presente o en el futuro.</label
          >
        </div>

        <div class="checkbox-item legal-item">
          <input
            type="checkbox"
            id="acepta_terminos_programa"
            name="acepta_terminos_programa"
            required
          />
          <label for="acepta_terminos_programa"
            >Acepto √≠ntegramente los T√©rminos y Condiciones del Programa de
            Incentivos JLC.</label
          >
        </div>
      </div>
    </fieldset>

    <div id="form-error-message" class="error-message" style="display: none;">
    </div>

    <div class="form-actions">
      <Button href="/login" variant="outline">Cancelar</Button>
      <Button type="submit" variant="primary">Registrar Cuenta</Button>
    </div>
  </form>
</Card>

<style>
  .registration-form {
    display: flex;

    flex-direction: column;

    gap: 2rem;
  }

  fieldset {
    border: none;

    padding: 0;

    margin: 0;
  }

  legend {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-main);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
    width: 100%;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .form-helper-text {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    margin-top: 0.3rem;
  }

  .form-helper-text.warning {
    color: #f6ad55;
  }
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .checkbox-item input[type="checkbox"] {
    width: 1.15em;
    height: 1.15em;
    accent-color: var(--color-accent);
  }

  .checkbox-item label {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1rem;
  }

  .error-message {
    background-color: rgba(229, 62, 62, 0.1);
    border: 1px solid #e53e3e;
    color: #fc8181;
    padding: 1rem;
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    text-align: center;
    margin-top: 1rem;
  }

  select.form-input {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }

  .legal-intro {
    font-size: 0.95rem;
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
    padding: 0.75rem 1rem;
    background-color: rgba(66, 153, 225, 0.1);
    border-left: 3px solid var(--color-accent);
    border-radius: var(--radius-sm);
  }

  .legal-declarations {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .legal-item {
    padding: 1rem;
    background-color: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all 0.2s;
  }

  .legal-item:hover {
    border-color: var(--color-accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .legal-item label {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--color-text-main);
    text-align: justify;
  }

  .legal-item input[type="checkbox"] {
    margin-top: 0.25rem;
    flex-shrink: 0;
  }

  .terms-link-box {
    background-color: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1.5rem;
    text-align: center;
    margin: 1rem;
  }

  .terms-link-box p {
    margin: 0;
    color: var(--color-text-main);
    font-size: 0.95rem;
  }

  .terms-link {
    color: var(--color-accent);
    font-weight: 600;
    text-decoration: underline;
    transition: color 0.2s;
  }

  .terms-link:hover {
    color: var(--color-accent-hover);
    text-decoration: none;
  }
  .accept-all-container {
    display: flex;
    justify-content: center;
    margin: 3rem;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registration-form");
    const errorMessageDiv = document.getElementById("form-error-message");

    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      // @ts-ignore
      errorMessageDiv.style.display = "none";
      // @ts-ignore
      errorMessageDiv.textContent = "";
      // @ts-ignore
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // --- VALIDACIONES FRONTEND ---

      // Passwords

      if (data.password !== data.password_confirm) {
        showError("Las contrase√±as no coinciden.");
        return;
      }
      // @ts-ignore
      if (data.password.length < 8 || !/\d/.test(data.password)) {
        showError(
          "La contrase√±a debe tener al menos 8 caracteres y un n√∫mero.",
        );
        return;
      }

      // Edad

      // @ts-ignore
      const birthDate = new Date(data.fecha_nacimiento);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();

      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }

      if (age < 18) {
        showError("Debes ser mayor de 18 a√±os para registrarte.");

        return;
      }

      // Checkboxes originales
      if (
        !data.acepta_tratamiento_datos ||
        !data.acepta_contacto_comercial ||
        !data.declara_info_verdadera
      ) {
        showError(
          "Debes aceptar todas las pol√≠ticas originales para continuar.",
        );
        return;
      }

      // Declaraciones legales del programa (8 nuevos checkboxes)
      const declaracionesLegales = [
        "declara_naturaleza_comercial",
        "reconoce_no_salario",
        "declara_no_subordinacion",
        "declara_relacion_autonoma",
        "acepta_liberalidades",
        "asume_obligaciones_tributarias",
        "declara_no_contrato",
        "acepta_terminos_programa",
      ];

      for (const declaracion of declaracionesLegales) {
        if (!data[declaracion]) {
          showError(
            `Debes aceptar todas las declaraciones legales del Programa de Incentivos para continuar.`,
          );
          return;
        }
      }

      // Convertir TODOS los checkboxes a booleano (11 total)
      // @ts-ignore - Converting FormData checkboxes to boolean
      data.acepta_tratamiento_datos = data.acepta_tratamiento_datos === "on";
      // @ts-ignore
      data.acepta_contacto_comercial = data.acepta_contacto_comercial === "on";
      // @ts-ignore
      data.declara_info_verdadera = data.declara_info_verdadera === "on";

      // Convertir declaraciones legales
      declaracionesLegales.forEach((declaracion) => {
        // @ts-ignore - Converting FormData checkboxes to boolean
        data[declaracion] = data[declaracion] === "on";
      });

      // --- ENV√çO A LA API ---

      const submitButton = form.querySelector(
        'button[type="submit"]',
      ) as HTMLButtonElement;
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = "Registrando...";
      }

      try {
        const response = await fetch(
          "http://localhost:8000/auth/register.php",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          },
        );

        const result = await response.json();

        if (result.status === 201) {
          alert(
            "¬°Registro exitoso! Tu cuenta ha sido creada y est√° pendiente de aprobaci√≥n. Ser√°s redirigido para iniciar sesi√≥n una vez que un administrador te apruebe.",
          );

          window.location.href = "/login";
        } else {
          showError(result.message || "Ocurri√≥ un error durante el registro.");
        }
      } catch (error) {
        // @ts-ignore
        showError("No se pudo conectar con el servidor. Int√©ntalo m√°s tarde.");
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = "Registrar Cuenta";
        }
      }
    });
    // @ts-ignore
    function showError(message) {
      // @ts-ignore
      errorMessageDiv.textContent = message;
      // @ts-ignore
      errorMessageDiv.style.display = "block";
      window.scrollTo(0, document.body.scrollHeight);
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const acceptAllBtn = document.getElementById("accept-all-terms-btn");
    if (acceptAllBtn) {
      acceptAllBtn.addEventListener("click", () => {
        const form = document.getElementById("registration-form");
        if (form) {
          const checkboxes = form.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach((checkbox) => {
            (checkbox as HTMLInputElement).checked = true;
          });
        }
      });
    }
  });
</script>
