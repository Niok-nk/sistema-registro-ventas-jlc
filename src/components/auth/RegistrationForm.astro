---
import Card from "../Card.astro";
import Button from "../Button.astro";
---

<Card title="Registro de Asesor JLC">
  <form id="registration-form" class="registration-form">
    <!-- SECCIÓN 1: INFORMACIÓN PERSONAL -->
    <fieldset>
      <legend>Información Personal</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="nombre" class="form-label">Nombre</label>
          <input
            type="text"
            id="nombre"
            name="nombre"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="apellido" class="form-label">Apellido</label>
          <input
            type="text"
            id="apellido"
            name="apellido"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="tipo_documento" class="form-label"
            >Tipo de Documento</label
          >
          <select
            id="tipo_documento"
            name="tipo_documento"
            class="form-input"
            required
          >
            <option value="CC">Cédula de Ciudadanía (CC)</option>
            <option value="CE">Cédula de Extranjería (CE)</option>
            <option value="NIT">NIT</option>
            <option value="Pasaporte">Pasaporte</option>
          </select>
        </div>
        <div class="form-group">
          <label for="numero_documento" class="form-label"
            >Número de Documento</label
          >
          <input
            type="text"
            id="numero_documento"
            name="numero_documento"
            class="form-input"
            required
          />
          <p class="form-helper-text">Este será tu usuario de acceso.</p>
        </div>
        <div class="form-group">
          <label for="fecha_nacimiento" class="form-label"
            >Fecha de Nacimiento</label
          >
          <input
            type="date"
            id="fecha_nacimiento"
            name="fecha_nacimiento"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="correo" class="form-label">Correo Electrónico</label>
          <input
            type="email"
            id="correo"
            name="correo"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="ciudad_residencia" class="form-label"
            >Ciudad de Residencia</label
          >
          <input
            type="text"
            id="ciudad_residencia"
            name="ciudad_residencia"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="departamento" class="form-label">Departamento</label>
          <input
            type="text"
            id="departamento"
            name="departamento"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="whatsapp" class="form-label">WhatsApp</label>
          <input
            type="tel"
            id="whatsapp"
            name="whatsapp"
            class="form-input"
            placeholder="+57 3001234567"
            required
          />
        </div>
        <div class="form-group">
          <label for="telefono" class="form-label">Teléfono (Opcional)</label>
          <input type="tel" id="telefono" name="telefono" class="form-input" />
        </div>
      </div>
    </fieldset>

    <!-- SECCIÓN 2: INFORMACIÓN DE DISTRIBUIDOR -->
    <fieldset>
      <legend>Información de Distribuidor</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="nombre_distribuidor" class="form-label"
            >Nombre del Distribuidor</label
          >
          <input
            type="text"
            id="nombre_distribuidor"
            name="nombre_distribuidor"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="ciudad_punto_venta" class="form-label"
            >Ciudad del Punto de Venta</label
          >
          <input
            type="text"
            id="ciudad_punto_venta"
            name="ciudad_punto_venta"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="direccion_punto_venta" class="form-label"
            >Dirección Punto de Venta (Opcional)</label
          >
          <input
            type="text"
            id="direccion_punto_venta"
            name="direccion_punto_venta"
            class="form-input"
          />
        </div>
        <div class="form-group">
          <label for="cargo" class="form-label">Cargo</label>
          <input
            type="text"
            id="cargo"
            name="cargo"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="antiguedad_meses" class="form-label"
            >Antigüedad (meses)</label
          >
          <input
            type="number"
            id="antiguedad_meses"
            name="antiguedad_meses"
            class="form-input"
            min="0"
            required
          />
        </div>
      </div>
    </fieldset>

    <!-- SECCIÓN 3: INFORMACIÓN FINANCIERA -->
    <fieldset>
      <legend>Información Financiera</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="metodo_pago" class="form-label">Método de Pago</label>
          <select
            id="metodo_pago"
            name="metodo_pago"
            class="form-input"
            required
          >
            <option value="Nequi">Nequi</option>
            <option value="Daviplata">Daviplata</option>
            <option value="Bancolombia">Bancolombia</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="llave_breb" class="form-label">Llave BRE-B</label>
          <input
            type="text"
            id="llave_breb"
            name="llave_breb"
            class="form-input"
            required
          />
          <p class="form-helper-text warning">
            ⚠️ La llave debe coincidir con tu nombre completo o no se realizarán
            pagos de bonos.
          </p>
        </div>
      </div>
    </fieldset>

    <!-- SECCIÓN 4: CONTRASEÑA Y POLÍTICAS -->
    <fieldset>
      <legend>Seguridad y Políticas</legend>
      <div class="form-grid">
        <div class="form-group">
          <label for="password" class="form-label">Contraseña</label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-input"
            required
          />
          <p class="form-helper-text">
            Mínimo 8 caracteres, al menos 1 número.
          </p>
        </div>
        <div class="form-group">
          <label for="password_confirm" class="form-label"
            >Confirmar Contraseña</label
          >
          <input
            type="password"
            id="password_confirm"
            name="password_confirm"
            class="form-input"
            required
          />
        </div>
      </div>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input
            type="checkbox"
            id="acepta_tratamiento_datos"
            name="acepta_tratamiento_datos"
            required
          />
          <label for="acepta_tratamiento_datos"
            >Acepto el tratamiento de datos personales.</label
          >
        </div>
        <div class="checkbox-item">
          <input
            type="checkbox"
            id="acepta_contacto_comercial"
            name="acepta_contacto_comercial"
            required
          />
          <label for="acepta_contacto_comercial"
            >Acepto recibir contacto comercial.</label
          >
        </div>
        <div class="checkbox-item">
          <input
            type="checkbox"
            id="declara_info_verdadera"
            name="declara_info_verdadera"
            required
          />
          <label for="declara_info_verdadera"
            >Declaro que toda la información es verdadera.</label
          >
        </div>
      </div>
    </fieldset>

    <div id="form-error-message" class="error-message" style="display: none;">
    </div>

    <div class="form-actions">
      <Button href="/login" variant="outline">Cancelar</Button>
      <Button type="submit" variant="primary">Registrar Cuenta</Button>
    </div>
  </form>
</Card>

<style>
  .registration-form {
    display: flex;

    flex-direction: column;

    gap: 2rem;
  }

  fieldset {
    border: none;

    padding: 0;

    margin: 0;
  }

  legend {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-main);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
    width: 100%;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .form-helper-text {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    margin-top: 0.3rem;
  }

  .form-helper-text.warning {
    color: #f6ad55;
  }
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .checkbox-item input[type="checkbox"] {
    width: 1.15em;
    height: 1.15em;
    accent-color: var(--color-accent);
  }

  .checkbox-item label {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1rem;
  }

  .error-message {
    background-color: rgba(229, 62, 62, 0.1);
    border: 1px solid #e53e3e;
    color: #fc8181;
    padding: 1rem;
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    text-align: center;
    margin-top: 1rem;
  }

  select.form-input {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
</style>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("registration-form");
    const errorMessageDiv = document.getElementById("form-error-message");

    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      errorMessageDiv.style.display = "none";
      errorMessageDiv.textContent = "";
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // --- VALIDACIONES FRONTEND ---

      // Passwords

      if (data.password !== data.password_confirm) {
        showError("Las contraseñas no coinciden.");
        return;
      }

      if (data.password.length < 8 || !/\d/.test(data.password)) {
        showError(
          "La contraseña debe tener al menos 8 caracteres y un número.",
        );
        return;
      }

      // Edad

      const birthDate = new Date(data.fecha_nacimiento);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();

      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }

      if (age < 18) {
        showError("Debes ser mayor de 18 años para registrarte.");

        return;
      }

      // Checkboxes

      if (
        !data.acepta_tratamiento_datos ||
        !data.acepta_contacto_comercial ||
        !data.declara_info_verdadera
      ) {
        showError("Debes aceptar todas las políticas para continuar.");
        return;
      }

      // Convertir checkboxes a booleano

      data.acepta_tratamiento_datos = data.acepta_tratamiento_datos === "on";
      data.acepta_contacto_comercial = data.acepta_contacto_comercial === "on";
      data.declara_info_verdadera = data.declara_info_verdadera === "on";

      // --- ENVÍO A LA API ---

      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = "Registrando...";

      try {
        const response = await fetch(
          "http://localhost:8000/api/auth/register.php",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          },
        );

        const result = await response.json();

        if (result.status === 201) {
          alert(
            "¡Registro exitoso! Tu cuenta ha sido creada y está pendiente de aprobación. Serás redirigido para iniciar sesión una vez que un administrador te apruebe.",
          );

          window.location.href = "/login";
        } else {
          showError(result.message || "Ocurrió un error durante el registro.");
        }
      } catch (error) {
        console.error("Error de red o de servidor:", error);

        showError("No se pudo conectar con el servidor. Inténtalo más tarde.");
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Registrar Cuenta";
      }
    });

    function showError(message) {
      errorMessageDiv.textContent = message;
      errorMessageDiv.style.display = "block";
      window.scrollTo(0, document.body.scrollHeight);
    }

    // Advertencia de Llave BRE-B

    const nombreInput = document.getElementById("nombre");
    const apellidoInput = document.getElementById("apellido");
    const llaveBrebInput = document.getElementById("llave_breb");
    const llaveBrebWarning = llaveBrebInput.nextElementSibling;

    function checkLlaveBreb() {
      const nombreCompleto =
        `${nombreInput.value.trim()} ${apellidoInput.value.trim()}`
          .trim()
          .toLowerCase();

      const llave = llaveBrebInput.value.trim().toLowerCase();

      if (llave && nombreCompleto && llave !== nombreCompleto) {
        llaveBrebWarning.style.color = "#E53E3E"; // Rojo error
      } else {
        llaveBrebWarning.style.color = "#f6ad55"; // Naranja advertencia original
      }
    }

    nombreInput.addEventListener("input", checkLlaveBreb);
    apellidoInput.addEventListener("input", checkLlaveBreb);
    llaveBrebInput.addEventListener("input", checkLlaveBreb);
  });
</script>
