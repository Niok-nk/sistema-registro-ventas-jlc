---
import Card from "../Card.astro";
import Button from "../Button.astro";
---

<Card title="Registrar Nueva Venta">
  <form class="sale-form" id="sale-form">
    <div class="form-grid">
      <div class="form-group">
        <label for="numero_factura" class="form-label">N° de Factura</label>
        <input
          type="text"
          id="numero_factura"
          name="numero_factura"
          class="form-input"
          placeholder="Ej: FCT-001234"
          required
        />
      </div>
      <div class="form-group">
        <label for="foto_factura" class="form-label">Foto de Factura</label>
        <input
          type="file"
          id="foto_factura"
          name="foto_factura"
          class="form-input file-input"
          accept=".jpg,.jpeg,.png,.pdf"
          required
        />
        <p class="form-helper-text">
          Formatos: JPG, PNG, PDF (Máx 5MB) - Obligatorio
        </p>
        <div id="file-preview" class="file-preview" style="display: none;">
          <img id="preview-image" src="" alt="Preview" style="display: none;" />
          <p id="preview-filename"></p>
          <button type="button" id="remove-file" class="btn-remove"
            >✕ Eliminar</button
          >
        </div>
        <div
          id="upload-progress"
          class="upload-progress"
          style="display: none;"
        >
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <p id="progress-text">Subiendo...</p>
        </div>
      </div>
      <div class="form-group">
        <label for="producto_jlc_search" class="form-label">Producto JLC</label>
        <div class="autocomplete-container">
          <input
            type="text"
            id="producto_jlc_search"
            name="producto_jlc_search"
            class="form-input"
            placeholder="Escribe para buscar por modelo o descripción..."
            required
            autocomplete="off"
          />
          <input type="hidden" id="producto_jlc" name="producto_jlc" />
          <div
            id="product-results"
            class="autocomplete-results"
            style="display: none;"
          >
          </div>
        </div>
        <p
          class="form-helper-text error-text"
          id="product-error"
          style="display: none;"
        >
          Error cargando lista de productos o no se encontraron coincidencias.
        </p>
      </div>
      <div class="form-group">
        <label for="numero_serie" class="form-label">N° de Serie</label>
        <input
          type="text"
          id="numero_serie"
          name="numero_serie"
          class="form-input"
          placeholder="Ej: SNXYZ7890"
          pattern="[A-Za-z0-9]+"
          title="Solo se permiten letras y números (sin espacios ni caracteres especiales)"
          required
        />
        <p class="form-helper-text warning-text">
          El número de serie debe ingresarse exactamente como aparece en el
          producto. Cualquier variación invalidará la redención del bono.
        </p>
      </div>
      <div class="form-group">
        <label for="fecha_venta" class="form-label">Fecha de Venta</label>
        <input
          type="date"
          id="fecha_venta"
          name="fecha_venta"
          class="form-input"
          required
        />
      </div>
    </div>
    <div class="form-actions">
      <Button type="reset" variant="outline">Cancelar</Button>
      <Button type="submit" variant="primary" id="submit-btn"
        >Registrar Venta</Button
      >
    </div>
  </form>
</Card>

<style>
  .sale-form {
    display: flex;
    flex-direction: column;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1rem;
  }

  /* Styling for select input */
  select.form-input {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  .form-input {
    height: 3rem;
  }

  /* Autocomplete styles */
  .autocomplete-container {
    position: relative;
  }

  :global(.autocomplete-results) {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 10;
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
    background: var(--color-bg-main);
    max-height: 200px;
    overflow-y: auto;
  }

  :global(.autocomplete-item) {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  :global(.autocomplete-item:hover) {
    background-color: var(--color-bg-hover);
  }

  :global(.autocomplete-item:last-child) {
    border-bottom-left-radius: var(--radius-md);
    border-bottom-right-radius: var(--radius-md);
  }

  :global(.autocomplete-item p) {
    margin: 0;
    color: var(--color-text-main);
  }

  :global(.autocomplete-item .item-description) {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
  }

  /* File input specific styles */
  .file-input {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }

  .form-helper-text {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
  }

  .warning-text {
    color: #f6ad55;
    font-weight: 500;
  }

  .error-text {
    color: #e57373;
    font-weight: 500;
  }

  /* File Preview */
  .file-preview {
    margin-top: 1rem;
    padding: 1rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-direction: column;
    overflow: hidden;
  }

  #preview-image {
    max-width: 120px;
    max-height: 120px;
    border-radius: var(--radius-md);
    object-fit: cover;
  }

  #preview-filename {
    flex-grow: 1;
    margin: 0;
    font-size: 0.875rem;
    color: var(--color-text-main);
  }

  .btn-remove {
    background: none;
    border: 1px solid #e57373;
    color: #e57373;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .btn-remove:hover {
    background: rgba(229, 115, 115, 0.1);
  }

  /* Upload Progress */
  .upload-progress {
    margin-top: 1rem;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-border);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-accent);
    transition: width 0.3s;
    width: 0%;
  }

  #progress-text {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }
</style>

<script is:inline>
  (function () {
    const API_BASE = "http://localhost:8000";
    const productSearchInput = document.getElementById("producto_jlc_search");
    const productHiddenInput = document.getElementById("producto_jlc");
    const productResultsContainer = document.getElementById("product-results");
    const productError = document.getElementById("product-error");
    const form = document.getElementById("sale-form");
    const fileInput = document.getElementById("foto_factura");
    const filePreview = document.getElementById("file-preview");
    const previewImage = document.getElementById("preview-image");
    const previewFilename = document.getElementById("preview-filename");
    const removeFileBtn = document.getElementById("remove-file");
    const uploadProgress = document.getElementById("upload-progress");
    const progressFill = document.getElementById("progress-fill");
    const progressText = document.getElementById("progress-text");
    const submitBtn = form.querySelector('button[type="submit"]');

    let uploadedFileUrl = "";
    let selectedFile = null;
    let allProducts = []; // Almacenar todos los productos

    // Cargar productos al iniciar
    fetch(`${API_BASE}/products/list.php`)
      .then((res) => res.json())
      .then((data) => {
        if (data.status === 200 && data.data) {
          // Guardar solo productos activos
          allProducts = data.data.filter((product) => product.activo == 1);
          productSearchInput.placeholder = "Buscar por modelo o descripción...";
        } else {
          throw new Error("Error en respuesta del servidor");
        }
      })
      .catch((err) => {
        console.error("Error cargando productos:", err);
        productSearchInput.placeholder = "Error al cargar productos";
        productError.style.display = "block";
      });

    // Lógica de autocompletado
    productSearchInput.addEventListener("input", () => {
      const query = productSearchInput.value.toLowerCase();
      productHiddenInput.value = ""; // Limpiar ID si el usuario modifica la búsqueda

      if (query.length < 2) {
        productResultsContainer.innerHTML = "";
        productResultsContainer.style.display = "none";
        return;
      }

      const filteredProducts = allProducts.filter(
        (p) =>
          p.modelo.toLowerCase().includes(query) ||
          p.descripcion.toLowerCase().includes(query),
      );

      displayResults(filteredProducts);
    });

    // Función para mostrar los resultados
    function displayResults(products) {
      productResultsContainer.innerHTML = "";
      if (products.length === 0) {
        productResultsContainer.style.display = "none";
        return;
      }

      products.forEach((product) => {
        const item = document.createElement("div");
        item.classList.add("autocomplete-item");
        item.dataset.id = product.id;
        item.innerHTML = `
          <p>${product.modelo}</p>
          <p class="item-description">${product.descripcion}</p>
        `;
        item.addEventListener("click", () => {
          productSearchInput.value = `${product.modelo} - ${product.descripcion}`;
          productHiddenInput.value = product.id;
          productResultsContainer.innerHTML = "";
          productResultsContainer.style.display = "none";
        });
        productResultsContainer.appendChild(item);
      });

      productResultsContainer.style.display = "block";
    }

    // Cerrar resultados si se hace clic fuera
    document.addEventListener("click", (e) => {
      if (!productSearchInput.contains(e.target)) {
        productResultsContainer.style.display = "none";
      }
    });

    // Preview de archivo
    fileInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      selectedFile = file;
      const isPDF = file.type === "application/pdf";

      previewFilename.textContent = file.name;

      if (isPDF) {
        previewImage.style.display = "none";
      } else {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      filePreview.style.display = "flex";
      uploadedFileUrl = ""; // Reset URL
    });

    // Eliminar archivo
    removeFileBtn.addEventListener("click", function () {
      fileInput.value = "";
      selectedFile = null;
      uploadedFileUrl = "";
      filePreview.style.display = "none";
      previewImage.src = "";
    });

    // Manejar envío del formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!productHiddenInput.value) {
        alert("Por favor, selecciona un producto válido de la lista.");
        return;
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("Sesión expirada. Por favor inicia sesión nuevamente.");
        window.location.href = "/login";
        return;
      }

      const formData = new FormData(form);
      let fotoUrl = uploadedFileUrl;

      try {
        // Paso 1: Subir archivo si hay uno seleccionado y aún no se ha subido
        if (selectedFile && !uploadedFileUrl) {
          submitBtn.disabled = true;
          uploadProgress.style.display = "block";
          progressText.textContent = "Subiendo archivo...";
          progressFill.style.width = "50%";

          const fileData = new FormData();
          fileData.append("file", selectedFile);

          const uploadResponse = await fetch(`${API_BASE}/uploads/upload.php`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: fileData,
          });

          const uploadResult = await uploadResponse.json();

          if (uploadResult.status === 200) {
            fotoUrl = uploadResult.data.url;
            uploadedFileUrl = fotoUrl;
            progressFill.style.width = "100%";
            progressText.textContent = "Archivo subido correctamente";
          } else {
            throw new Error(uploadResult.message || "Error al subir archivo");
          }
        }

        // Paso 2: Registrar venta con URL del archivo
        progressText.textContent = "Registrando venta...";

        const data = {
          numero_factura: formData.get("numero_factura"),
          producto_id: formData.get("producto_jlc"), // Ya tenemos el ID del input hidden
          numero_serie: formData.get("numero_serie"),
          fecha_venta: formData.get("fecha_venta"),
          foto_factura: fotoUrl || "",
        };

        const response = await fetch(`${API_BASE}/sales/create.php`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.status === 201) {
          alert("¡Venta registrada exitosamente!");
          form.reset();
          productSearchInput.value = ""; // Limpiar campo de búsqueda
          filePreview.style.display = "none";
          uploadProgress.style.display = "none";
          uploadedFileUrl = "";
          selectedFile = null;
          // window.location.href = '/dashboard/ventas';
        } else {
          throw new Error(result.message || "Error al registrar la venta");
        }
      } catch (error) {
        console.error("Error:", error);
        alert(error.message || "Error de conexión. Intenta nuevamente.");
      } finally {
        submitBtn.disabled = false;
        uploadProgress.style.display = "none";
        progressFill.style.width = "0%";
      }
    });
  })();
</script>
