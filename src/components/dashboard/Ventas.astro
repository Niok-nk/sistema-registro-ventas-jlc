---
import Card from "../Card.astro";
import VentasFilters from "./ventas/VentasFilters.astro";
import VentasStates from "./ventas/VentasStates.astro";
import VentasTable from "./ventas/VentasTable.astro";
---

<Card title="Historial de Ventas">
  <VentasFilters />

  <div class="sales-table-wrapper">
    <VentasStates />
    <VentasTable />
  </div>
</Card>

<style>
  /* Table Wrapper - único estilo que se queda aquí */
  .sales-table-wrapper {
    overflow-x: auto;
    min-height: 300px;
  }
</style>

<script is:inline>
  (function () {
    const API_BASE = "/api";

    let allSales = [];
    let allProducts = [];
    let currentFilteredSales = []; // Array con ventas filtradas actualmente

    // Export elements
    const exportBtn = document.getElementById("export-btn");
    const exportMenu = document.getElementById("export-menu");
    const exportCount = document.getElementById("export-count");

    // Elementos DOM
    const loadingState = document.getElementById("loading-state");
    const errorState = document.getElementById("error-state");
    const emptyState = document.getElementById("empty-state");
    const salesTable = document.getElementById("sales-table");
    const salesTbody = document.getElementById("sales-tbody");
    const retryBtn = document.getElementById("retry-btn");
    const filterBtn = document.getElementById("filter-btn");
    const searchInput = document.getElementById("search");
    const productFilter = document.getElementById("filtro-producto");
    const fechaDesde = document.getElementById("fecha-desde");
    const fechaHasta = document.getElementById("fecha-hasta");

    // Funciones de estado
    function showLoading() {
      loadingState.style.display = "flex";
      errorState.style.display = "none";
      emptyState.style.display = "none";
      salesTable.style.display = "none";
    }

    function showError() {
      loadingState.style.display = "none";
      errorState.style.display = "flex";
      emptyState.style.display = "none";
      salesTable.style.display = "none";
    }

    function showEmpty() {
      loadingState.style.display = "none";
      errorState.style.display = "none";
      emptyState.style.display = "flex";
      salesTable.style.display = "none";
    }

    function showTable() {
      loadingState.style.display = "none";
      errorState.style.display = "none";
      emptyState.style.display = "none";
      salesTable.style.display = "table";
    }

    // Cargar productos para filtro
    async function loadProducts() {
      try {
        const response = await fetch(`${API_BASE}/products/list.php`);
        const data = await response.json();

        if (data.status === 200 && data.data) {
          allProducts = data.data;
          populateProductFilter();
        }
      } catch (error) {
        console.error("Error cargando productos:", error);
      }
    }

    function populateProductFilter() {
      const currentValue = productFilter.value;
      productFilter.innerHTML = '<option value="">Todos los productos</option>';

      // Solo mostrar productos activos
      allProducts
        .filter((product) => product.activo == 1)
        .forEach((product) => {
          const option = document.createElement("option");
          option.value = product.id;
          option.textContent = product.modelo;
          productFilter.appendChild(option);
        });

      productFilter.value = currentValue;
    }

    // Cargar ventas
    async function loadSales() {
      showLoading();
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "/login";
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/sales/list.php`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json();

        if (data.status === 200 && data.data) {
          allSales = data.data;
          renderSales(allSales);
        } else if (response.status === 401) {
          localStorage.clear();
          window.location.href = "/login";
        } else {
          throw new Error(data.message || "Error desconocido");
        }
      } catch (error) {
        console.error("Error cargando ventas:", error);
        showError();
      }
    }

    // Renderizar ventas
    function renderSales(sales) {
      if (!sales || sales.length === 0) {
        showEmpty();
        return;
      }

      salesTbody.innerHTML = "";

      // Verificar si el usuario es administrador
      const userRole = localStorage.getItem("userRole");
      const isAdmin = userRole === "admin" || userRole === "administrador";

      sales.forEach((sale) => {
        const row = document.createElement("tr");

        // Columna de foto
        const photoBtn = sale.foto_factura
          ? `<button class="btn-view-photo" data-photo="${sale.foto_factura}" title="Ver foto">
               <svg viewBox="0 0 20 20" fill="currentColor" style="width:1.25rem;height:1.25rem">
                 <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 013.25 3h13.5A2.25 2.25 0 0119 5.25v9.5A2.25 2.25 0 0116.75 17H3.25A2.25 2.25 0 011 14.75v-9.5zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-2.69l-2.22-2.219a.75.75 0 00-1.06 0l-1.91 1.909-.48-.48a.75.75 0 00-1.06 0l-5.18 5.182H2.5v-3.578l3.22-3.22a.75.75 0 011.06 0l1.47 1.47 1.91-1.909a.75.75 0 011.06 0l2.97 2.97zM10 8a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
               </svg>
             </button>`
          : `<span style="color:var(--color-text-secondary);font-size:0.875rem">Sin foto</span>`;

        // Estado: Selector para admin, badge para usuarios
        const estadoHTML = isAdmin
          ? `<select class="status-selector" data-sale-id="${sale.id}" data-current-status="${sale.estado || "pendiente"}">
               <option value="pendiente" ${(sale.estado || "pendiente") === "pendiente" ? "selected" : ""}>Pendiente</option>
               <option value="aprobada" ${sale.estado === "aprobada" ? "selected" : ""}>Aprobada</option>
               <option value="rechazada" ${sale.estado === "rechazada" ? "selected" : ""}>Rechazada</option>
             </select>`
          : `<span class="status-badge status-${(sale.estado || "pendiente").toLowerCase()}">${sale.estado || "Pendiente"}</span>`;

        row.innerHTML = `
                <td>${sale.id}</td>
                <td>${sale.fecha_venta || "N/A"}</td>
                <td>${sale.numero_factura || "N/A"}</td>
                <td>${sale.modelo_producto || sale.desc_producto || "N/A"}</td>
                <td>${sale.numero_serie || "N/A"}</td>
                <td>
                  <div style="font-weight:500">${sale.nombre_asesor || ""} ${sale.apellido_asesor || ""}</div>
                  <div style="font-size:0.75rem;color:var(--color-text-secondary)">CC: ${sale.cedula_asesor || "N/A"}</div>
                </td>
                <td>${sale.nombre_distribuidor || "N/A"}</td>
                <td>${estadoHTML}</td>
                <td>${photoBtn}</td>
            `;
        salesTbody.appendChild(row);
      });

      // Event listeners para botones de fotos
      document.querySelectorAll(".btn-view-photo").forEach((btn) => {
        btn.addEventListener("click", function () {
          const photoPath = this.getAttribute("data-photo");
          if (photoPath) {
            // Extraer solo el nombre del archivo de la ruta /uploads/facturas/nombre.jpg
            const filename = photoPath.split("/").pop();
            const token = localStorage.getItem("token");
            // Abrir visor seguro
            window.open(
              `/api/sales/view_receipt.php?file=${filename}&token=${token}`,
              "_blank",
            );
          }
        });
      });

      // Event listeners para selectores de estado (solo para admin)
      if (isAdmin) {
        document.querySelectorAll(".status-selector").forEach((select) => {
          select.addEventListener("change", async function () {
            const saleId = this.getAttribute("data-sale-id");
            const newStatus = this.value;
            const currentStatus = this.getAttribute("data-current-status");

            if (newStatus === currentStatus) return;

            if (!confirm(`¿Cambiar estado de la venta a "${newStatus}"?`)) {
              // Restaurar valor anterior
              this.value = currentStatus;
              return;
            }

            await updateSaleStatus(saleId, newStatus, this);
          });
        });
      }

      showTable();
    }

    // Función para actualizar estado de venta
    async function updateSaleStatus(saleId, newStatus, selectElement) {
      try {
        const token = localStorage.getItem("token");
        const response = await fetch(`${API_BASE}/sales/update_status.php`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            id: parseInt(saleId),
            estado: newStatus,
          }),
        });

        const result = await response.json();

        if (result.status === 200) {
          alert("✅ Estado actualizado exitosamente");
          // Actualizar el atributo data-current-status
          selectElement.setAttribute("data-current-status", newStatus);
          // Recargar ventas para reflejar cambios
          loadSales();
        } else {
          alert("❌ Error: " + result.message);
          // Restaurar valor anterior
          selectElement.value = selectElement.getAttribute(
            "data-current-status",
          );
        }
      } catch (error) {
        alert("❌ Error al actualizar: " + error.message);
        // Restaurar valor anterior
        selectElement.value = selectElement.getAttribute("data-current-status");
      }
    }

    // Filtrar ventas
    function filterSales() {
      const search = searchInput.value.toLowerCase();
      const productId = productFilter.value;
      const dateFrom = fechaDesde.value;
      const dateTo = fechaHasta.value;

      let filtered = allSales;

      // Filtro por búsqueda (factura o serie)
      if (search) {
        filtered = filtered.filter(
          (sale) =>
            (sale.numero_factura || "").toLowerCase().includes(search) ||
            (sale.numero_serie || "").toLowerCase().includes(search),
        );
      }

      // Filtro por producto
      if (productId) {
        filtered = filtered.filter(
          (sale) => String(sale.producto_id) === String(productId),
        );
      }

      // Filtro por rango de fechas
      if (dateFrom || dateTo) {
        filtered = filtered.filter((sale) => {
          if (!sale.fecha_venta) return false;

          const saleDate = new Date(sale.fecha_venta);

          if (dateFrom) {
            const fromDate = new Date(dateFrom);
            if (saleDate < fromDate) return false;
          }

          if (dateTo) {
            const toDate = new Date(dateTo);
            // Agregar un día para incluir toda la fecha "hasta"
            toDate.setDate(toDate.getDate() + 1);
            if (saleDate >= toDate) return false;
          }

          return true;
        });
      }

      currentFilteredSales = filtered; // Guardar para exportación
      renderSales(filtered);
      updateExportButton(); // Actualizar contador
    }

    // Event listeners
    if (retryBtn) {
      retryBtn.addEventListener("click", loadSales);
    }

    if (filterBtn) {
      filterBtn.addEventListener("click", filterSales);
    }

    // Búsqueda en tiempo real mientras se escribe
    if (searchInput) {
      searchInput.addEventListener("input", filterSales);
    }

    // Filtrar automáticamente al cambiar producto
    if (productFilter) {
      productFilter.addEventListener("change", filterSales);
    }

    // Filtrar automáticamente al cambiar fechas
    if (fechaDesde) {
      fechaDesde.addEventListener("change", filterSales);
    }

    if (fechaHasta) {
      fechaHasta.addEventListener("change", filterSales);
    }

    // ===== FUNCIONES DE EXPORTACIÓN =====
    // Nota: Estas funciones se mantienen aquí porque <script is:inline>
    // no puede importar módulos ES6

    // Actualizar estado del botón de exportar
    function updateExportButton() {
      const count = currentFilteredSales.length;
      if (exportCount) exportCount.textContent = count;
      if (exportBtn) exportBtn.disabled = count === 0;
    }

    // Generar timestamp para nombres de archivo
    function getTimestamp() {
      const now = new Date();
      return now.toISOString().slice(0, 19).replace(/:/g, "-");
    }

    // Escapar valores para CSV
    function escapeCSV(value) {
      if (value === null || value === undefined) return "";
      const str = String(value);
      if (str.includes(",") || str.includes('"') || str.includes("\n")) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }

    // Exportar a CSV
    function exportToCSV(sales) {
      // 1. Headers
      const headers = [
        "ID",
        "Fecha",
        "N° Factura",
        "Producto",
        "N° Serie",
        "Asesor",
        "Cédula",
        "Llave BRE-B",
        "Distribuidor",
        "Estado",
      ];

      // 2. Datos
      const rows = sales.map((sale) => [
        sale.id || "",
        sale.fecha_venta || "",
        sale.numero_factura || "",
        sale.modelo_producto || sale.desc_producto || "",
        sale.numero_serie || "",
        `${sale.nombre_asesor || ""} ${sale.apellido_asesor || ""}`.trim(),
        sale.cedula_asesor || "",
        sale.llave_breb || "",
        sale.nombre_distribuidor || "",
        sale.estado || "",
      ]);
      // 3. Combinar en string CSV
      const csvContent = [
        headers.join(","),
        ...rows.map((row) => row.map(escapeCSV).join(",")),
      ].join("\n");

      // 4. Crear Blob y descargar (UTF-8 con BOM para Excel)
      const blob = new Blob(["\uFEFF" + csvContent], {
        type: "text/csv;charset=utf-8;",
      });

      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `ventas_${getTimestamp()}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      console.log(`Exportadas ${sales.length} ventas a CSV`);
    }

    // Exportar a Excel
    function exportToExcel(sales) {
      if (typeof XLSX === "undefined") {
        alert("Error: Librería de Excel no disponible");
        return;
      }

      // 1. Preparar datos en formato tabla
      const data = [
        // Headers
        [
          "ID",
          "Fecha",
          "N° Factura",
          "Producto",
          "Código Producto",
          "N° Serie",
          "Asesor",
          "Cédula",
          "Llave BRE-B",
          "Distribuidor",
          "Estado",
          "Link Foto",
        ],

        // Datos
        ...sales.map((sale) => [
          sale.id || "",
          sale.fecha_venta || "",
          sale.numero_factura || "",
          sale.modelo_producto || sale.desc_producto || "",
          sale.codigo_producto || "",
          sale.numero_serie || "",
          `${sale.nombre_asesor || ""} ${sale.apellido_asesor || ""}`.trim(),
          sale.cedula_asesor || "",
          sale.llave_breb || "",
          sale.nombre_distribuidor || "",
          sale.estado || "",
          sale.foto_url || "",
        ]),
      ];
      // 2. Crear worksheet
      const ws = XLSX.utils.aoa_to_sheet(data);

      // 3. Ajustar anchos de columna
      ws["!cols"] = [
        { wch: 8 }, // ID
        { wch: 12 }, // Fecha
        { wch: 15 }, // N° Factura
        { wch: 25 }, // Producto
        { wch: 15 }, // Código Producto
        { wch: 15 }, // N° Serie
        { wch: 25 }, // Asesor
        { wch: 12 }, // Cédula
        { wch: 20 }, // Llave BRE-B
        { wch: 25 }, // Distribuidor
        { wch: 12 }, // Estado
        { wch: 50 }, // Link Foto (más ancho para URLs)
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ventas");

      // 5. Generar archivo y descargar
      XLSX.writeFile(wb, `ventas_${getTimestamp()}.xlsx`);

      console.log(`✅ Exportadas ${sales.length} ventas a Excel`);
    }

    // ===== EVENT LISTENERS DE EXPORTACIÓN =====

    // Toggle export menu
    if (exportBtn) {
      exportBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (exportMenu) {
          exportMenu.classList.toggle("show");
        }
      });
    }

    // Cerrar menu al hacer click fuera
    document.addEventListener("click", () => {
      if (exportMenu && exportMenu.classList.contains("show")) {
        exportMenu.classList.remove("show");
      }
    });

    // Manejar selección de formato
    if (exportMenu) {
      exportMenu.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const format = btn.getAttribute("data-format");

          if (currentFilteredSales.length === 0) {
            alert("No hay ventas para exportar");
            return;
          }

          if (format === "excel") {
            exportToExcel(currentFilteredSales);
          } else if (format === "csv") {
            exportToCSV(currentFilteredSales);
          }

          // Cerrar menu
          exportMenu.classList.remove("show");
        });
      });
    }

    // Inicializar
    loadProducts();
    loadSales();
  })();
</script>
