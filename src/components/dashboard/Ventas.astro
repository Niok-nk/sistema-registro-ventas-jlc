---
import Card from "../Card.astro";
import Button from "../Button.astro";
---

<Card title="Historial de Ventas">
  <div class="filters-container">
    <div class="main-filters">
      <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 20 20" fill="currentColor"
          ><path
            fill-rule="evenodd"
            d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
            clip-rule="evenodd"></path></svg
        >
        <input
          type="text"
          id="search"
          class="form-input search-input"
          placeholder="Buscar por N° Factura o Serie..."
        />
      </div>
      <div class="form-group">
        <select id="filtro-producto" class="form-input">
          <option value="">Todos los productos</option>
        </select>
      </div>
      <Button variant="outline" id="filter-btn">Filtrar</Button>
    </div>
  </div>

  <div class="sales-table-wrapper">
    <div id="loading-state" class="state-message">
      <div class="spinner"></div>
      <p>Cargando ventas...</p>
    </div>

    <div id="error-state" class="state-message" style="display: none;">
      <svg class="error-icon" viewBox="0 0 20 20" fill="currentColor"
        ><path
          fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
          clip-rule="evenodd"></path></svg
      >
      <p>Error al cargar las ventas</p>
      <Button variant="outline" id="retry-btn">Reintentar</Button>
    </div>

    <div id="empty-state" class="state-message" style="display: none;">
      <svg class="empty-icon" viewBox="0 0 20 20" fill="currentColor"
        ><path
          fill-rule="evenodd"
          d="M5.5 3A2.5 2.5 0 003 5.5v9A2.5 2.5 0 005.5 17h9a2.5 2.5 0 002.5-2.5v-9A2.5 2.5 0 0014.5 3h-9zm5.25 9.5a.75.75 0 00-1.5 0V14a.75.75 0 001.5 0v-1.5zM10 8a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0v-2.5A.75.75 0 0110 8z"
          clip-rule="evenodd"></path></svg
      >
      <p>No hay ventas registradas</p>
    </div>

    <table class="sales-table" id="sales-table" style="display: none;">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>N° Factura</th>
          <th>Producto</th>
          <th>N° Serie</th>
          <th>Estado</th>
          <th>Foto</th>
        </tr>
      </thead>
      <tbody id="sales-tbody">
        <!-- Contenido dinámico -->
      </tbody>
    </table>
  </div>
</Card>

<style>
  /* States */
  .state-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    text-align: center;
    color: var(--color-text-secondary);
  }

  .state-message p {
    margin: 1rem 0;
    font-size: 1.125rem;
  }

  .spinner {
    border: 3px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .error-icon,
  .empty-icon {
    width: 3rem;
    height: 3rem;
    color: var(--color-text-secondary);
  }

  /* Filters */
  .filters-container {
    margin-bottom: 2rem;
  }

  .main-filters {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .search-wrapper {
    position: relative;
    flex-grow: 1;
    min-width: 200px;
  }

  .search-icon {
    position: absolute;
    left: 0.875rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-text-secondary);
  }

  .search-input {
    padding-left: 2.75rem;
  }

  .form-group {
    margin-bottom: 0;
  }

  /* Table */
  .sales-table-wrapper {
    overflow-x: auto;
    min-height: 300px;
  }

  .sales-table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
    font-size: 0.9rem;
  }

  .sales-table th,
  .sales-table td {
    padding: 0.875rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
  }

  .sales-table thead {
    background-color: var(--color-bg-card);
  }

  .sales-table th {
    text-transform: uppercase;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    letter-spacing: 0.05em;
  }

  .sales-table tbody tr:hover {
    background-color: var(--color-bg-card);
  }

  /* Status Badge */
  .status-badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
  }

  .status-aprobada {
    background-color: rgba(56, 161, 105, 0.2);
    color: #68d391;
  }

  .status-pendiente {
    background-color: rgba(221, 107, 32, 0.2);
    color: #f6ad55;
  }

  .status-rechazada {
    background-color: rgba(229, 62, 62, 0.2);
    color: #fc8181;
  }

  /* Photo button */
  .btn-view-photo {
    background: none;
    border: 1px solid var(--color-accent);
    color: var(--color-accent);
    padding: 0.5rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .btn-view-photo:hover {
    background: rgba(66, 153, 225, 0.1);
  }
</style>

<script is:inline>
  (function () {
    const API_BASE = "http://localhost:8000";

    let allSales = [];
    let allProducts = [];

    // Elementos DOM
    const loadingState = document.getElementById("loading-state");
    const errorState = document.getElementById("error-state");
    const emptyState = document.getElementById("empty-state");
    const salesTable = document.getElementById("sales-table");
    const salesTbody = document.getElementById("sales-tbody");
    const retryBtn = document.getElementById("retry-btn");
    const filterBtn = document.getElementById("filter-btn");
    const searchInput = document.getElementById("search");
    const productFilter = document.getElementById("filtro-producto");

    // Funciones de estado
    function showLoading() {
      loadingState.style.display = "flex";
      errorState.style.display = "none";
      emptyState.style.display = "none";
      salesTable.style.display = "none";
    }

    function showError() {
      loadingState.style.display = "none";
      errorState.style.display = "flex";
      emptyState.style.display = "none";
      salesTable.style.display = "none";
    }

    function showEmpty() {
      loadingState.style.display = "none";
      errorState.style.display = "none";
      emptyState.style.display = "flex";
      salesTable.style.display = "none";
    }

    function showTable() {
      loadingState.style.display = "none";
      errorState.style.display = "none";
      emptyState.style.display = "none";
      salesTable.style.display = "table";
    }

    // Cargar productos para filtro
    async function loadProducts() {
      try {
        const response = await fetch(`${API_BASE}/products/list.php`);
        const data = await response.json();

        if (data.status === 200 && data.data) {
          allProducts = data.data;
          populateProductFilter();
        }
      } catch (error) {
        console.error("Error cargando productos:", error);
      }
    }

    function populateProductFilter() {
      const currentValue = productFilter.value;
      productFilter.innerHTML = '<option value="">Todos los productos</option>';

      allProducts.forEach((product) => {
        const option = document.createElement("option");
        option.value = product.id;
        option.textContent = product.modelo;
        productFilter.appendChild(option);
      });

      productFilter.value = currentValue;
    }

    // Cargar ventas
    async function loadSales() {
      showLoading();
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "/login";
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/sales/list.php`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json();

        if (data.status === 200 && data.data) {
          allSales = data.data;
          renderSales(allSales);
        } else if (response.status === 401) {
          localStorage.clear();
          window.location.href = "/login";
        } else {
          throw new Error(data.message || "Error desconocido");
        }
      } catch (error) {
        console.error("Error cargando ventas:", error);
        showError();
      }
    }

    // Renderizar ventas
    function renderSales(sales) {
      if (!sales || sales.length === 0) {
        showEmpty();
        return;
      }

      salesTbody.innerHTML = "";

      sales.forEach((sale) => {
        const row = document.createElement("tr");

        // Columna de foto
        const photoBtn = sale.foto_factura
          ? `<button class="btn-view-photo" data-photo="${sale.foto_factura}" title="Ver foto">
               <svg viewBox="0 0 20 20" fill="currentColor" style="width:1.25rem;height:1.25rem">
                 <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 013.25 3h13.5A2.25 2.25 0 0119 5.25v9.5A2.25 2.25 0 0116.75 17H3.25A2.25 2.25 0 011 14.75v-9.5zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 00.75-.75v-2.69l-2.22-2.219a.75.75 0 00-1.06 0l-1.91 1.909-.48-.48a.75.75 0 00-1.06 0l-5.18 5.182H2.5v-3.578l3.22-3.22a.75.75 0 011.06 0l1.47 1.47 1.91-1.909a.75.75 0 011.06 0l2.97 2.97zM10 8a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
               </svg>
             </button>`
          : `<span style="color:var(--color-text-secondary);font-size:0.875rem">Sin foto</span>`;

        row.innerHTML = `
                <td>${sale.fecha_venta || "N/A"}</td>
                <td>${sale.numero_factura || "N/A"}</td>
                <td>${sale.modelo_producto || sale.desc_producto || "N/A"}</td>
                <td>${sale.numero_serie || "N/A"}</td>
                <td><span class="status-badge status-${(sale.estado || "pendiente").toLowerCase()}">${sale.estado || "Pendiente"}</span></td>
                <td>${photoBtn}</td>
            `;
        salesTbody.appendChild(row);
      });

      // Event listeners para botones de fotos
      document.querySelectorAll(".btn-view-photo").forEach((btn) => {
        btn.addEventListener("click", function () {
          const photoUrl = this.getAttribute("data-photo");
          if (photoUrl) {
            window.open("http://localhost:8000" + photoUrl, "_blank");
          }
        });
      });

      showTable();
    }

    // Filtrar ventas
    function filterSales() {
      const search = searchInput.value.toLowerCase();
      const productId = productFilter.value;

      let filtered = allSales;

      if (search) {
        filtered = filtered.filter(
          (sale) =>
            (sale.numero_factura || "").toLowerCase().includes(search) ||
            (sale.numero_serie || "").toLowerCase().includes(search),
        );
      }

      if (productId) {
        filtered = filtered.filter(
          (sale) => String(sale.producto_id) === String(productId),
        );
      }

      renderSales(filtered);
    }

    // Event listeners
    if (retryBtn) {
      retryBtn.addEventListener("click", loadSales);
    }

    if (filterBtn) {
      filterBtn.addEventListener("click", filterSales);
    }

    if (searchInput) {
      searchInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") filterSales();
      });
    }

    // Inicializar
    loadProducts();
    loadSales();
  })();
</script>
