---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Card from "../../components/Card.astro";
import ProductForm from "../../components/dashboard/productos/ProductForm.astro";
import ProductList from "../../components/dashboard/productos/ProductList.astro";
import ProductsManager from "../../components/dashboard/productos/ProductsManager.astro";
---

<DashboardLayout title="Gestión de Productos - JLC">
  <div class="productos-page">
    <!-- Encabezado -->
    <div class="page-header">
      <h1>Gestión de Productos JLC</h1>
      <p class="subtitle">
        Administra el catálogo de productos disponibles para el registro de
        ventas
      </p>
    </div>

    <!-- Formulario de agregar producto -->
    <Card title="Agregar Nuevo Producto">
      <ProductForm />
    </Card>

    <!-- Lista de productos existentes -->
    <Card title="Catálogo de Productos">
      <ProductList />
    </Card>
  </div>

  <!-- Lógica de manejo de productos -->
  <ProductsManager />

  <script is:inline>
    // Verificar que el usuario sea administrador
    (function () {
      try {
        const userStr = localStorage.getItem("user");
        if (!userStr) {
          console.warn("No user data found, redirecting to login");
          window.location.href = "/login";
          return;
        }

        const user = JSON.parse(userStr);
        if (user.rol !== "admin" && user.rol !== "administrador") {
          console.warn("User is not admin, redirecting to dashboard");
          alert("Acceso denegado. Esta página es solo para administradores.");
          window.location.href = "/dashboard";
        }
      } catch (e) {
        console.error("Error checking admin role:", e);
        window.location.href = "/login";
      }
    })();

    // Inicializar el manager cuando cargue la página
    // Detectar entorno: si estamos en localhost usa puerto 8000, si no usa /api relativo
    const API_BASE =
      window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1"
        ? "http://localhost:8000"
        : window.location.origin + "/api";

    document.addEventListener("DOMContentLoaded", () => {
      if (window.ProductsManager) {
        window.ProductsManager.init(API_BASE);
      }
    });
  </script>
</DashboardLayout>

<style is:global>
  .productos-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2rem;
    color: var(--color-text-main);
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: var(--color-text-secondary);
    font-size: 1rem;
  }

  /* ========== ProductList Styles (workaround) ========== */
  .products-cards {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .product-card {
    background-color: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 1rem;
    transition: box-shadow 0.2s;
  }

  .product-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .product-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
  }

  .product-card-title {
    font-weight: 600;
    color: var(--color-accent);
    font-size: 1.1rem;
  }

  .product-card-body {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .product-card-row {
    display: flex;
    justify-content: space-between;
  }

  .product-card-label {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .product-card-value {
    color: var(--color-text-main);
    font-weight: 500;
  }

  .product-card-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-border);
  }

  .btn-icon {
    padding: 0.5rem;
    background-color: transparent;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: background-color 0.2s;
    font-size: 1.2rem;
    color: var(--color-text-main);
    border: 1px solid var(--color-border);
    font-size: 0.8rem;
  }

  .btn-icon:hover {
    background-color: var(--color-bg-card);
    box-shadow: var(--shadow-sm);
  }

  @media (max-width: 768px) {
    .productos-page {
      padding: 1rem 0.5rem;
    }

    .page-header h1 {
      font-size: 1.5rem;
    }
  }
</style>
